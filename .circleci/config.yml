version: 2.1

# export PLAN_ARGS
# terraform destroy -input=false -no-color -auto-approve $PLAN_ARGS "$module_path"
# terraform output -json > "<< parameters.output_path >>"
# unset TF_WORKSPACE
# terraform apply -var="image_id=ami-abc123"
# terraform apply -var='image_id_map={"us-east-1":"ami-abc123","us-east-2":"ami-def456"}'
# terraform apply -var='image_id_list=["ami-abc123","ami-def456"]'

secrets: &secrets
  context: cdk8s

aliases:
  # command / job parameters
  params:
    path: &path
      path:
        type: "string"
        description: "Path to the terraform module"
    var: &var
      var:
        type: "string"
        description: "Comma separated list of vars to set, e.g. 'foo=bar,bas=foo'"
        default: ""
    var_file: &var_file
      var_file:
        type: "string"
        description: "Comma separated list of var file paths"
        default: ""
    auto_approve: &auto_approve
      auto_approve:
        type: "boolean"
        description: "Automatically approve and apply plan"
        default: false
    workspace: &workspace
      workspace:
        type: "string"
        description: "Name of the terraform workspace"
        default: "default"
    backend_config: &backend_config
      backend_config:
        type: "string"
        description: "Comma separated list of backend configs to set, e.g. 'foo=bar'"
        default: ""

# codify structure of orb inline
orbs:
  # orb name @ top
  tf:
    # the 'tf' orb contains the following jobs
    jobs:
      # pass a map of jobs
      init: # init terraform directory
        executor: terraform-executor
        working_directory: "~/src"
        steps:
          - checkout
          - t:
            # nest the param(s) under the command declaration
              cmd_name: "init"
      # going to codify the rest of the "dummy" job declarations
      validate:
        parameters:
          # many of these jobs share common params

        executor: terraform-executor
        working_directory: "/src"
        steps:
          - checkout
          - t:
              cmd_name: "validate"
      plan:
        executor: terraform-executor
        working_directory: "/src"
        steps:
          - checkout
      apply:
        description: "Apply a Terraform plan"
        executor: terraform-executor
        working_directory: "/src"
        steps:
          - checkout
      destroy:
        executor: terraform-executor
        working_directory: "/src"
        steps:
          - checkout
          - destroy
      test-command-sequence:
        description: perform e2e tests on command sequence
        executor: terraform-executor
        working_directory: "/src"
        steps:
          - checkout
          # execute terraform lifecycle
          - init
          - fmt
          - validate
          - plan
          - apply
          - destroy
      gent:
        description: "generic command"
        executor: terraform-executor
        working_directory: "~/src"
        steps:
          - checkout
          - validate:
              path: "."
          - plan:
              path: "/tmp"
              workspace: "testing"
          - apply:
              path: "."
              auto_approve: true
              var : "tag1=one,tag2=two"
              workspace: "lovelolo"
          #    var_file: "terraform.tfvars"
          #- destroy:
          #    path: "."
          #    workspace: "testing"
# Emphasis will be placed on individual command declarations
    commands:
      # t is a generalized abstraction
      t:
        parameters:
          cmd_name:
            type: string
            default: ""
        steps:
          - run:
              name: terraform << parameters.cmd_name >>
              command: terraform << parameters.cmd_name >>
      # all of the top level commands included in the atomic
      # job declarations will be made available as individual commands
      init:
        parameters:
          ## param map goes here
          options:
            type: string
            default: ""
        steps:
          - run:
              name: terraform init
              command: terraform init
      validate:
        description: "Validate TF files"
        # create an anchor within an anchor
        parameters: &validate-parameters
          <<: *path
        steps:
          - init
          - run:
              name: terraform validate
              command: |
                # 'path' is a required parameter, save it as module_path
                readonly module_path="<< parameters.path >>"
                export path=$module_path
                # what is the significance of no color?
                terraform validate -no-color "$module_path"

      fmt:
        steps:
          - run:
              name: terraform fmt
              command: terraform fmt
      plan:
        description: "Generate Terraform plan"
        # ovo parameterizes this, e.g.
        # parameters: &plan-parameters
        parameters:
          <<: *path
          <<: *workspace
          <<: *backend_config
          <<: *backend_config_file
          <<: *var
          <<: *var_file
        #<<: *parallelism
        steps:
          # TF init
          - init
          - run:
            # need to parameterize input and output
              name: terraform plan
              command: |
                # 'path' is a required parameter, save it as module_path
                readonly module_path="<< parameters.path >>"
                export path=$module_path

                if [[ ! -d "$module_path" ]]; then
                  echo "Path does not exist: \"$module_path\""
                  exit 1
                fi
                # Set workspace from parameter, allowing it to be overridden by TF_WORKSPACE.
                # If TF_WORKSPACE is set we don't want terraform init to use the value, in the case we are running new_workspace.sh this would cause an error
                readonly workspace_parameter="<< parameters.workspace >>"
                readonly workspace="${TF_WORKSPACE:-$workspace_parameter}"
                export workspace
                unset TF_WORKSPACE
                terraform workspace select -no-color "$workspace"
                terraform plan $module_path
      apply:
        description: "Apply Terraform plan"
        parameters:
          <<: *path
          <<: *auto_approve
          <<: *var
          <<: *var_file
        steps:
          - run:
              name: terraform apply
              command: |
                # 'path' is a required parameter, save it as module_path
                readonly module_path="<< parameters.path >>"
                export path=$module_path

                if [[ ! -d "$module_path" ]]; then
                  echo "Path does not exist: \"$module_path\""
                  exit 1
                fi
                # Set workspace from parameter, allowing it to be overridden by TF_WORKSPACE.
                # If TF_WORKSPACE is set we don't want terraform init to use the value, in the case we are running new_workspace.sh this would cause an error
                readonly workspace_parameter="<< parameters.workspace >>"
                readonly workspace="${TF_WORKSPACE:-$workspace_parameter}"
                export workspace
                unset TF_WORKSPACE
                terraform workspace select -no-color "$workspace"
                if [[ -n "<< parameters.var >>" ]]; then
                    for var in $(echo "<< parameters.var >>" | tr ',' '\n'); do
                        PLAN_ARGS="$PLAN_ARGS -var $var"
                    done
                fi
                if [[ -n "<< parameters.var_file >>" ]]; then
                for file in $(echo "<< parameters.var_file >>" | tr ',' '\n'); do
                    if [[ -f "$file" ]]; then
                        PLAN_ARGS="$PLAN_ARGS -var-file=$file"
                    elif [[ -f "$module_path/$file" ]]; then
                        PLAN_ARGS="$PLAN_ARGS -var-file=$module_path/$file"
                    else
                        echo "Var file '$file' wasn't found" >&2
                        exit 1
                    fi
                done
                fi
                export PLAN_ARGS
                if [[ "<< parameters.auto_approve >>" == "true" ]];
                  echo "Automatically applying plan"
                  terraform apply -auto-approve $PLAN_ARGS
                then
                  echo "Manual approval required"
                fi
      destroy:
        description: "Destroy current state"
        parameters:
          <<: *path
          <<: *workspace
        steps:
          - run:
              name: terraform destroy
              command: |
                terraform destroy -input=false -no-color -auto-approve
                # export PLAN_ARGS
                # terraform destroy -input=false -no-color -auto-approve $PLAN_ARGS
    executors:
      terraform-executor:
        parameters:
          working_dir:
            type: string
            default: "~/src"
        # specify executor type ~ any reason to make resource class a param?
        docker:
          - image: hashicorp/terraform:light
        working_directory: << parameters.working_dir >>

workflows:
  plan-approve-apply:
    jobs:
      #- tf/destroy:
      #    <<: *secrets
      #- tf/test-command-sequence:
      #    <<: *secrets
      - tf/gent:
          <<: *secrets
      
        