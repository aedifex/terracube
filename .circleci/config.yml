version: 2.1

jobs:
  terraform-plan:
    docker:
      - image: hashicorp/terraform:light
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Setup Terraform Credentials
          command: |
            mkdir -p ~/.terraform.d
            echo "{\"credentials\": {\"aedifexhack.jfrog.io\": {\"token\": \"${JFROG}\"}}}" > ~/.terraform.d/credentials.tfrc.json
      - run:
          name: Terraform Init
          command: terraform init
      - run:
          name: Terraform Plan
          command: |
            terraform plan \
              -var "aws_access_key=${AWS_ACCESS_KEY_ID}" \
              -var "aws_secret_key=${AWS_SECRET_ACCESS_KEY}"


  terraform-apply:
    docker:
      - image: hashicorp/terraform:light
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Setup Terraform Credentials
          command: |
            mkdir -p ~/.terraform.d
            echo "{\"credentials\": {\"aedifexhack.jfrog.io\": {\"token\": \"${JFROG}\"}}}" > ~/.terraform.d/credentials.tfrc.json
      - run:
          name: Terraform Init
          command: terraform init
      - run:
          name: Terraform Apply
          command: |
            terraform apply \
              -var "aws_access_key=${AWS_ACCESS_KEY_ID}" \
              -var "aws_secret_key=${AWS_SECRET_ACCESS_KEY}" \
              --auto-approve

  iac-security-scanning:
    docker:
      - image: hashicorp/terraform:light
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Run code security tests
          command: echo "code security"

  compliance-checks:
    docker:
      - image: hashicorp/terraform:light
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Run compliance checks
          command: echo "compliance checks"

  cost-estimator:
    docker:
      - image: hashicorp/terraform:light
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Estimate infra costs
          command: echo "Estimate infra costs"

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - terraform-plan
      - iac-security-scanning
      - terraform-approve:
          type: approval
          requires:
            - terraform-plan
            - iac-security-scanning
      - terraform-apply:
          requires:
            - terraform-approve
            - compliance-checks
            - cost-estimator
